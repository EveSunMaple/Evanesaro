---
import { Icon } from "astro-icon/components";

interface Props {
  slug: string;
}

const { slug } = Astro.props;
---

<div class="comments-list space-y-6" data-slug={slug}>
  <div class="loading-comments flex justify-center">
    <span class="loading loading-spinner loading-lg"></span>
  </div>
</div>

<script>
  import * as AV from "leancloud-storage";
  import { format } from "date-fns";

  function initCommentList() {
    const commentsList = document.querySelector(".comments-list");
    const slug = commentsList.dataset.slug;

    async function loadComments() {
      try {
        const query = new AV.Query("Comment");
        query.equalTo("slug", slug);
        query.ascending("createdAt");

        const comments = await query.find();

        // Build comment tree
        const commentTree = buildCommentTree(comments);

        // Render comments
        commentsList.innerHTML = renderComments(commentTree);

        // Add reply handlers
        addReplyHandlers();
      } catch (error) {
        console.error("Error loading comments:", error);
        commentsList.innerHTML = `
          <div class="alert alert-error">
            <span>Error loading comments. Please try again later.</span>
          </div>
        `;
      }
    }

    function buildCommentTree(comments) {
      const commentMap = new Map();
      const roots = [];

      comments.forEach((comment) => {
        const data = {
          id: comment.id,
          ...comment.toJSON(),
          children: [],
        };
        commentMap.set(data.id, data);

        if (data.parentId) {
          const parent = commentMap.get(data.parentId);
          if (parent) {
            parent.children.push(data);
          }
        } else {
          roots.push(data);
        }
      });

      return roots;
    }

    function renderComments(comments, level = 0) {
      if (!comments.length) {
        return '<p class="text-center text-base-content/70">No comments yet. Be the first to comment!</p>';
      }

      return comments
        .map(
          (comment) => `
        <div class="comment" style="margin-left: ${level * 2}rem">
          <div class="flex gap-4">
            <div class="avatar">
              <div class="w-10 h-10 rounded-full">
                <img src="${comment.avatar}" alt="${comment.nickname}" />
              </div>
            </div>
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                ${
                  comment.website
                    ? `<a href="${comment.website}" class="font-semibold hover:text-primary" target="_blank" rel="noopener noreferrer">
                    ${comment.nickname}
                  </a>`
                    : `<span class="font-semibold">${comment.nickname}</span>`
                }
                <span class="text-sm text-base-content/60">
                  ${format(new Date(comment.createdAt), "PPp")}
                </span>
              </div>
              <div class="prose prose-sm max-w-none mb-2">
                ${comment.content}
              </div>
              <button class="btn btn-ghost btn-sm reply-button" data-comment-id="${comment.id}">
                <Icon name="lucide:reply" class="w-4 h-4 mr-1" />
                Reply
              </button>
            </div>
          </div>
          ${comment.children.length ? renderComments(comment.children, level + 1) : ""}
        </div>
      `,
        )
        .join("");
    }

    function addReplyHandlers() {
      document.querySelectorAll(".reply-button").forEach((button) => {
        button.addEventListener("click", () => {
          const commentId = button.dataset.commentId;
          const comment = button.closest(".comment");

          // Remove any existing reply forms
          document
            .querySelectorAll(".reply-form")
            .forEach((form) => form.remove());

          // Add new reply form
          const replyForm = document.createElement("div");
          replyForm.className = "reply-form mt-4 ml-14";
          replyForm.innerHTML = `
            <form class="comment-form" data-slug="${slug}" data-parent-id="${commentId}">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-control">
                  <label class="label">
                    <span class="label-text">Nickname*</span>
                  </label>
                  <input type="text" name="nickname" class="input input-bordered w-full" required minlength="2" maxlength="50">
                </div>
                <div class="form-control">
                  <label class="label">
                    <span class="label-text">Email*</span>
                  </label>
                  <input type="email" name="email" class="input input-bordered w-full" required>
                </div>
              </div>
              <div class="form-control">
                <label class="label">
                  <span class="label-text">Website</span>
                </label>
                <input type="url" name="website" class="input input-bordered w-full" placeholder="https://">
              </div>
              <div class="form-control">
                <label class="label">
                  <span class="label-text">Comment*</span>
                </label>
                <textarea name="content" class="textarea textarea-bordered h-24" required minlength="2"></textarea>
                <label class="label">
                  <span class="label-text-alt">Supports Markdown</span>
                </label>
              </div>
              <div class="flex justify-end gap-2">
                <button type="button" class="btn btn-ghost cancel-reply">Cancel Reply</button>
                <button type="submit" class="btn btn-primary submit-button">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                  </svg>
                  Submit
                </button>
              </div>
            </form>
          `;

          comment.appendChild(replyForm);
          initCommentForm();
        });
      });
    }

    // Load comments initially
    loadComments();

    // Reload comments when updated
    document.addEventListener("commentsUpdated", loadComments);
  }

  // Initialize on page load and after navigation
  document.addEventListener("astro:page-load", initCommentList);
</script>
